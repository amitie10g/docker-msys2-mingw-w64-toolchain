name: Publish

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        version:
        - 2022
        - 2019
    runs-on: windows-${{ matrix.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}


      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull parent image for cache
        shell: cmd
        run: |
          docker pull ghcr.io/${{ github.repository_owner }}/msys2:ltsc${{ matrix.version }}
          docker tag ghcr.io/${{ github.repository_owner }}/msys2:ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/msys2:ltsc${{ matrix.version }}

      - name: Build base
        shell: cmd
        run: docker build --target base --build-arg VERSION="ltsc${{ matrix.version }}" .

      - name: Build the rest
        env:
          COMPILERS: >-
            gcc-ucrt
            clang-i686
            clang-x86_64
            clang-aarch64
            cross-gcc
            cross-clang
            gcc-i686
        run: >
          ${{ env.COMPILERS }} -split ' ' | ForEach-Object -Parallel {
            docker build 
            --build-arg VERSION="ltsc${{ matrix.version }}"
            --build-arg TOOLCHAIN="mingw-w64-${_}-toolchain"
            --build-arg MSYSTEM=$(switch (${_}) {
                "ucrt-x86_64"   { "UCRT64" }
                "clang-i686"    { "CLANG32" }
                "clang-x86_64"  { "CLANG64" }
                "clang-aarch64" { "CLANGARM64" }
                "cross"         { "MINGW64" }
                "cross-clang"   { "CLANG64" }
                "gcc-i686"      { "MINGW32" }
                "gcc-x86_64"    { "MINGW64" }
              })
            -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:${_}-ltsc${{ matrix.version }}
            -t ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:${_}-ltsc${{ matrix.version }}
            $(if (${_} -eq "gcc-x86_64") {
              -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-x86_64-ltsc${{ matrix.version }}
              -t ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-x86_64-ltsc${{ matrix.version }}
            })
            .
          }

      - name: Tag latest Windows version (Docker Hub)
        if: strategy.job-index == 0
        run: |
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-x86_64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-x86_64
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-x86_64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-i686-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-i686
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-aarch64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-aarch64
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:cross-gcc-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:cross-gcc
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:cross-clang-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:cross-clang
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-i686-riscv64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-i686-riscv64
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-x86_64-riscv64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:clang-x86_64-riscv64
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:i686-riscv64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:i686-riscv64
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:x86_64-riscv64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:x86_64-riscv64
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:x86_64-riscv64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:riscv64
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:ucrt-x86_64-riscv64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:ucrt-x86_64-riscv64
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-ucrt-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-ucrt
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-ucrt-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:ucrt
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-i686-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-i686
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-i686-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:i686
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-x86_64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-x86_64
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-x86_64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:x86_64
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-x86_64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}:gcc-x86_64-ltsc${{ matrix.version }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }}

      - name: Tag latest Windows version (ghcr.io)
        if: strategy.job-index == 0
        run: |
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-x86_64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-x86_64
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-x86_64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-i686-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-i686
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-aarch64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-aarch64
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:cross-gcc-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:cross-gcc
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:cross-clang-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:cross-clang
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-i686-riscv64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-i686-riscv64
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-x86_64-riscv64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:clang-x86_64-riscv64
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:i686-riscv64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:i686-riscv64
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:x86_64-riscv64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:x86_64-riscv64
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:x86_64-riscv64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:riscv64
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:ucrt-x86_64-riscv64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:ucrt-x86_64-riscv64
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-ucrt-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-ucrt
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-ucrt-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:ucrt
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-i686-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-i686
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-i686-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:i686
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-x86_64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-x86_64
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-x86_64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:x86_64
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-x86_64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc
          docker tag ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}:gcc-x86_64-ltsc${{ matrix.version }} ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }}

      - name: Push
        shell: cmd
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.IMG_NAME }} --all-tags
          docker push ghcr.io/${{ github.repository_owner }}/${{ vars.IMG_NAME }} --all-tags
